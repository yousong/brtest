## Test machines

2 Physical hosts with the following configurations

- 2 Intel Xeon E5-2650 v2 @ 2.60Ghz on 2 sockets
- 256 (16 * 16) GB memory
- Intel Corporation Ethernet Controller 10-Gigabit X540-AT2 (rev 03)

Softwares and their versions

- CentOS 6.6 with 2.6.32-431.20.3.el6.xxxx.x86_64
- Open vSwitch 2.3.2
- Open vSwitch 1.11.0
- Netperf 2.6.0

## How tests were run

2 hosts A and B were involved in the tests.

- Host A has IP address `10.4.22.18`
- Host B has IP address `10.4.22.19`
- Open vSwitch 2.3.2 was installed on host A
- Open vSwitch 1.11.0 was installed on host B

Configure the system according to commands in `sysconfig.sh`

- HyperThreading was disabled by kernel parameter `maxcpus=16`
- Interrupts of 16 queues of NIC were distributed to all cores with `set_irq_affinity.sh`
- `rx`, `tx`, `sg` and other offload features were all off
- `rx-flow-hash` of `tcp4` was set to sdfn
- `tcp_tw_recycle` and `tcp_tw_reuse` were enabled
- Disable connection tracking on flows involved

`./netns-env-ovs-internal.sh` and `./netns-env-bridge.sh` were used to create test environement:

- 127 net namespaces were created on one of the 2 hosts
- Each namespace was allocated an interface that were connected to the bridge in `init_net`
- Addresses (`10.0.77.0/24`) and routes were installed on both host A and host B so that they can access each other from different namespaces

Then we run the following commands from host A and host B

	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n   1 -T '-b 100' run
	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n  16 -T '-b 100' run
	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n  32 -T '-b 100' run
	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 127 -T '-b 100' run

	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n   1 -T '-b 100' run
	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n  16 -T '-b 100' run
	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n  32 -T '-b 100' run
	sudo ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 127 -T '-b 100' run

- Run on host A to test Open vSwitch 2.3.2
- Run twice on host B to test Open vSwitch 1.11.0 and Linux bridge respectively
- Each run will test localhost performance and performance with NIC involved
- 1, 16, 32, 127 pairs of netserver/netperf will be tested

Results were saved in directory `logs.t-netns-netperf-bridge.sh-TCP_CRR-H10.4.22.1*` and can be parsed with

	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n   1 -T '-b 100' sum 2>/dev/null
	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n  16 -T '-b 100' sum 2>/dev/null
	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n  32 -T '-b 100' sum 2>/dev/null
	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 127 -T '-b 100' sum 2>/dev/null

	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n   1 -T '-b 100' sum 2>/dev/null
	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n  16 -T '-b 100' sum 2>/dev/null
	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n  32 -T '-b 100' sum 2>/dev/null
	./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 127 -T '-b 100' sum 2>/dev/null

## result: Linux bridge with veth

NIC involved

	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 1 -T '-b 100' sum
	6      64     7002.60  3585331.20
	70     128    6871.71  7036631.04
	198    256    6896.25  14123520.00
	454    512    6801.65  27859558.40
	966    1024   6812.76  55810129.92
	1222   1280   6491.40  66471936.00
	1460   1518   6319.72  76746679.68
	8960   9018   3513.51  253478665.44
	65495  65553  1033.32  541897807.68
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 16 -T '-b 100' sum
	6      64     77086.27  39468170.24
	70     128    77419.49  79277557.76
	198    256    76597.02  156870696.96
	454    512    76168.61  311986626.56
	966    1024   74881.10  613425971.20
	1222   1280   73571.44  753371545.60
	1460   1518   70999.75  862220964.00
	8960   9018   35360.38  2551039254.72
	65495  65553  10712.39  5617834413.36
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 32 -T '-b 100' sum
	6      64     107927.91  55259089.92
	70     128    107207.26  109780234.24
	198    256    106544.36  218202849.28
	454    512    104542.59  428206448.64
	966    1024   103486.45  847760998.40
	1222   1280   102843.14  1053113753.60
	1460   1518   96808.31   1175640116.64
	8960   9018   48544.12   3502166993.28
	65495  65553  13235.67   6941103004.08
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 127 -T '-b 100' sum
	6      64     114306.23  58524789.76
	70     128    116011.64  118795919.36
	198    256    115117.29  235760209.92
	454    512    114174.43  467658465.28
	966    1024   116022.09  950452961.28
	1222   1280   113158.10  1158738944.00
	1460   1518   108790.84  1321155960.96
	8960   9018   55867.53   4030507084.32
	65495  65553  14250.06   7473073465.44

localhost

	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 1 -T '-b 100' sum
	6      64     12714.42  6509783.04
	70     128    12563.81  12865341.44
	198    256    12557.26  25717268.48
	454    512    12631.04  51736739.84
	966    1024   12631.99  103481262.08
	1222   1280   12552.32  128535756.80
	1460   1518   11046.09  134143716.96
	8960   9018   8613.23   621392865.12
	65495  65553  4090.47   2145140639.28
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 16 -T '-b 100' sum
	6      64     167592.32  85807267.84
	70     128    167496.10  171516006.40
	198    256    166533.89  341061406.72
	454    512    166135.93  680492769.28
	966    1024   166852.13  1366852648.96
	1222   1280   166160.10  1701479424.00
	1460   1518   143158.23  1738513545.12
	8960   9018   109773.79  7919520305.76
	65495  65553  47600.50   24962844612.00
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 32 -T '-b 100' sum
	6      64     159403.54  81614612.48
	70     128    164906.30  168864051.20
	198    256    159341.89  326332190.72
	454    512    164747.30  674804940.80
	966    1024   164522.80  1347770777.60
	1222   1280   163461.60  1673846784.00
	1460   1518   137277.01  1667092009.44
	8960   9018   105714.06  7626635144.64
	65495  65553  44560.03   23368349172.72
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 127 -T '-b 100' sum
	6      64     163958.67  83946839.04
	70     128    164618.15  168568985.60
	198    256    162784.26  333382164.48
	454    512    165092.17  676217528.32
	966    1024   163796.46  1341820600.32
	1222   1280   162517.90  1664183296.00
	1460   1518   140376.69  1704734523.36
	8960   9018   107306.14  7741494164.16
	65495  65553  46056.52   24153144444.48

## result: Open vSwitch 1.11.0 with internal port

NIC involved

	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 1 -T '-b 100' sum
	6      64     5237.66  2681681.92
	70     128    5273.63  5400197.12
	198    256    5255.22  10762690.56
	454    512    5198.39  21292605.44
	966    1024   5062.80  41474457.60
	1222   1280   5017.09  51375001.60
	1460   1518   4771.82  57948982.08
	8960   9018   3122.67  225281904.48
	65495  65553  1310.95  687493642.80
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 16 -T '-b 100' sum
	6      64     19051.91  9754577.92
	70     128    17815.91  18243491.84
	198    256    19067.63  39050506.24
	454    512    19016.61  77892034.56
	966    1024   18952.47  155258634.24
	1222   1280   19060.04  195174809.60
	1460   1518   18731.75  227478372.00
	8960   9018   17221.43  1242422845.92
	65495  65553  8661.57   4542335185.68
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 32 -T '-b 100' sum
	6      64     19344.90  9904588.80
	70     128    19327.10  19790950.40
	198    256    19269.67  39464284.16
	454    512    19246.94  78835466.24
	966    1024   19178.89  157113466.88
	1222   1280   19173.26  196334182.40
	1460   1518   18958.19  230228259.36
	8960   9018   16799.75  1212001164.00
	65495  65553  9657.35   5064546116.40
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 127 -T '-b 100' sum
	6      64     19453.62  9960253.44
	70     128    19486.32  19953991.68
	198    256    19622.21  40186286.08
	454    512    19303.06  79065333.76
	966    1024   19231.60  157545267.20
	1222   1280   19172.51  196326502.40
	1460   1518   19205.22  233228191.68
	8960   9018   16241.08  1171696475.52
	65495  65553  9298.39   4876298877.36

localhost

	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 1 -T '-b 100' sum
	6      64     8801.20  4506214.40
	70     128    9104.47  9322977.28
	198    256    9108.71  18654638.08
	454    512    9159.43  37517025.28
	966    1024   9132.37  74812375.04
	1222   1280   9068.00  92856320.00
	1460   1518   8401.80  102031459.20
	8960   9018   7039.69  507871395.36
	65495  65553  3681.66  1930750863.84
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 16 -T '-b 100' sum
	6      64     22337.28  11436687.36
	70     128    22036.89  22565775.36
	198    256    22296.71  45663662.08
	454    512    22470.68  92039905.28
	966    1024   21787.67  178484592.64
	1222   1280   21713.10  222342144.00
	1460   1518   20756.79  252070457.76
	8960   9018   21782.71  1571491830.24
	65495  65553  18308.37  9601348628.88
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 32 -T '-b 100' sum
	6      64     22014.88  11271618.56
	70     128    21979.46  22506967.04
	198    256    21941.66  44936519.68
	454    512    21268.00  87113728.00
	966    1024   21741.67  178107760.64
	1222   1280   21798.66  223218278.40
	1460   1518   21200.57  257459722.08
	8960   9018   19364.24  1397013730.56
	65495  65553  17137.09  8987101286.16
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 127 -T '-b 100' sum
	6      64     21615.18  11066972.16
	70     128    21495.54  22011432.96
	198    256    21158.79  43333201.92
	454    512    21921.08  89788743.68
	966    1024   21618.67  177100144.64
	1222   1280   21763.21  222855270.40
	1460   1518   21346.15  259227645.60
	8960   9018   19160.90  1382343969.60
	65495  65553  14988.38  7860266193.12

## result: Open vSwitch 1.11.0 with internal port

NIC involved

	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 1 -T '-b 100' sum
	6      64     7857.16  4022865.92
	70     128    7805.56  7992893.44
	198    256    7764.79  15902289.92
	454    512    7651.24  31339479.04
	966    1024   7459.27  61106339.84
	1222   1280   7315.71  74912870.40
	1460   1518   6818.05  82798399.20
	8960   9018   3539.90  255382545.60
	65495  65553  1289.05  676008757.20
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 16 -T '-b 100' sum
	6      64     90649.46  46412523.52
	70     128    89515.53  91663902.72
	198    256    87965.33  180152995.84
	454    512    87176.30  357074124.80
	966    1024   85227.42  698183024.64
	1222   1280   84666.91  866989158.40
	1460   1518   79371.78  963890896.32
	8960   9018   40286.26  2906411941.44
	65495  65553  11650.04  6109560576.96
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 32 -T '-b 100' sum
	6      64     125296.89  64152007.68
	70     128    124625.30  127616307.20
	198    256    123170.69  252253573.12
	454    512    121856.87  499125739.52
	966    1024   120580.22  987793162.24
	1222   1280   119794.00  1226690560.00
	1460   1518   112312.70  1363925428.80
	8960   9018   58961.43   4253713405.92
	65495  65553  15045.86   7890410084.64
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.19 -n 127 -T '-b 100' sum
	6      64     127873.84  65471406.08
	70     128    127082.16  130132131.84
	198    256    127944.56  262030458.88
	454    512    130506.89  534556221.44
	966    1024   128267.50  1050767360.00
	1222   1280   126814.86  1298584166.40
	1460   1518   118746.22  1442054095.68
	8960   9018   68993.59   4977473556.96
	65495  65553  16861.53   8842591008.72

localhost

	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 1 -T '-b 100' sum
	6      64     12784.52  6545674.24
	70     128    12744.02  13049876.48
	198    256    12857.71  26332590.08
	454    512    12800.34  52430192.64
	966    1024   12726.08  104252047.36
	1222   1280   12684.44  129888665.60
	1460   1518   11185.97  135842419.68
	8960   9018   8839.28   637701016.32
	65495  65553  4176.52   2190267324.48
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 16 -T '-b 100' sum
	6      64     165237.97  84601840.64
	70     128    173677.45  177845708.80
	198    256    174204.30  356770406.40
	454    512    174157.78  713350266.88
	966    1024   164317.20  1346086502.40
	1222   1280   173915.16  1780891238.40
	1460   1518   152452.07  1851377938.08
	8960   9018   100370.76  7241148109.44
	65495  65553  51429.23   26970722513.52
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 32 -T '-b 100' sum
	6      64     171760.40  87941324.80
	70     128    171977.69  176105154.56
	198    256    171533.69  351300997.12
	454    512    171663.86  703135170.56
	966    1024   170867.84  1399749345.28
	1222   1280   170345.43  1744337203.20
	1460   1518   149780.68  1818936577.92
	8960   9018   118636.22  8558891455.68
	65495  65553  53543.34   28079412536.16
	+ ./t-netns-netperf-bridge.sh -t TCP_CRR -H 10.4.22.18 -n 127 -T '-b 100' sum
	6      64     171400.86  87757240.32
	70     128    173479.22  177642721.28
	198    256    174865.04  358123601.92
	454    512    173062.14  708862525.44
	966    1024   171087.19  1401546260.48
	1222   1280   173668.34  1778363801.60
	1460   1518   152001.09  1845901236.96
	8960   9018   116830.18  8428596505.92
	65495  65553  51882.07   27208202677.68
